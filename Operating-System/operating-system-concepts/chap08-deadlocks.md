# Deadlocks

## System model

다른 요구사항을 가진 여러 프로세스에 할당하기 위해 시스템 모델을 메모리, 프린터, CPU 등의 카테고리로 분류할 수 있다.

프로세스는 위해 다음과 같은 순서로 자원을 사용한다.

- 요청(request): 자원을 요청한다. 다른 프로세스가 자원을 사용중이라서 할당받을 수 없으면 대기한다.
- 사용(use): 자원을 할당받아 사용한다.
- 릴리즈(release): 프로세스가 자원의 소유권을 놓아준다.

데드락은 여러 프로세스들이 다른 프로세스에 할당된 자원을 기다리고 있어 무한히 대기하며 태스크를 처리할 수 없는 상태를 의미한다.

<br>

## Deadlock Characterization

### Resource-Allocation Graph

자원 할당 그래프를 사용하면 데드락을 명확하게 이해할 수 있다.

- 자원 할당 그래프가 사이클을 가지지 않는다면 해당 시스템은 데드락 상태가 아니다.
- 사이클을 가진다면 데드락 상태일 가능성이 있다.

| 데드락 상태의 자원 할당 그래프                                                                            | 데드락 상태가 아닌 자원 할당 그래프                                                                                 |
| --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| ![deadlock](https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/images/Chapter7/7_02_Deadlock.jpg) | ![no deadlock](https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/images/Chapter7/7_03_CycleNoDeadlock.jpg) |

또한 데드락은 다음과 같은 4가지 조건을 충족하면 발생한다.

- 상호 배제(mutual exclusion): 여러 프로세스 중 하나의 프로세스만 임계 구역에 들어간다.
- 점유 대기(hold and wait): 프로세스가 자원을 사용중이면 다른 프로세스는 대기중이어야 한다.
- 비선점(no preemption): 운영체제가 현재 실행중인 프로세스를 임의로 중단시킬 수 없다.
- 순환 대기(circular wait): 프로세스가 자원을 순환적으로 대기하고 있다.

이 중 하나라도 만족하지 않는다면 데드락은 발생하지 않는다.

<br>

## Moethods for Handling Deadlocks

데드락은 다음과 같은 방법으로 제어할 수 있다.

- 무시하는 방법
- 데드락을 감지하고 복구하는 방법: 데드락이 감지되면 프로세스를 중단하거나 일부 리소스를 선점한다.
- 데드락을 방지하고 회피하는 방법: 시스템이 데드락이 되지 않도록 방지하고 회피한다.

<br>

## Deadlock Prevention

데드락을 방지하는 방법은 데드락 발생 조건을 충족시키지 않음으로써 데드락이 발생하지 않도록 하는 것이다.

데드락이 발생하는 4가지 조건을 예방하는 방법은 다음과 같다.

- 상호 배제: 여러 프로세스가 하나의 자원을 공유할 수 있게 한다.
- 점유 대기: 프로세스가 다른 자원을 기다리는 동안 다른 자원을 보유하지 못하게 한다.
- 비선점: 높은 우선순위의 프로세스가 자원을 선점할 수 있게 한다.
- 순환 대기: 순환 형태로 자원을 대기할 수 없게하기 위해 한쪽 방향으로만 자원을 요구할 수 있게 한다.

4가지 조건중 하나라도 만족하지 않도록 하게 하면 데드락을 발생시키지 않게 할 수 있지만 디바이스 효올과 시스템 성능을 떨어트린다는 단점이 있다.

## Deadlock Avoidance

데드락을 회피하는 방법은 자원을 요청하고 사용한 후 종료될 때 까지의 과정에서 데드락이 발생할 것 같으면 시스템이 자원요청을 승인하지 않는 방법이다.

- 프로세스들이 요청하는 모든 자원이 데드락을 발생시키지 않으면서 프로세스들에게 할당할 수 있으면 안정 상태에 있다고 한다.
- 위와 같은 상황에서 데드락이 발생할 가능성이 있다면 불안정 상태라고 한다. 데드락은 불안정 상태에서 발생할 수 있따.

데드락이 발생할 가능성은 자원 할당 그래프를 구현하거나 은행원 알고리즘을 통해 판단하며 불안정 상태가 되면 안정 상태로 복구를 시도한다.

### Banker's Algorhtim

[Link](https://jhnyang.tistory.com/102)

<br>

## Deadlock Detection

시스템은 데드락을 방지하고 회피하기 위해 데드락을 감지한다.

- 자원이 단일 인스턴스인 경우 자원 할당 그래프의 변형 형태인 대기 그래프를 통해 감지한다.
- 시스템 콜, 자원 할당 그래프 및 감지 알고리즘을 통해 감지한다.

<br>

## Recovery from Deadlock

데드락을 복구하는 방법에는 3가지가 있다.

- 시스템의 개입을 허용한다.
- 데드락과 관련된 프로세스를 종료시킨다.
- 자원을 선점한다.

프로세스를 종료시키면 데드락을 확실히 복구할 수 있지만 데드락이 복구 될 때까지 프로세스를 하나씩 종료 시키며 매 단계에서 데드락을 감지해야 하므로 큰 비용이 요구된다.

자원을 선점해 데드락을 복구할 때에는 다음과 같은 문제를 해결해야 한다.

- 종료할 프로세스 결정(selecting a vicim): 종료 시킬 프로세스를 결정해야 한다.
- 롤백(rollback): 데드락이 발생하기 전 상태로 되돌려야 한다.
- 기아 상태(starvation): 계속 같은 프로세스가 종료 대상이 되면 기아 상태가 발생할 수 있다.

---

### Reference

- [운영체제 공룡책 강의](https://www.inflearn.com/course/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B3%B5%EB%A3%A1%EC%B1%85-%EC%A0%84%EA%B3%B5%EA%B0%95%EC%9D%98/lecture/65282?tab=note&volume=1.00&quality=auto&speed=1)
