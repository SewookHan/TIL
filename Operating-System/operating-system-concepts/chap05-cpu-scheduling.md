# CPU Scheduling

## Basic Concepts

CPU 스케줄링이란 여러개의 프로세스가 메모리에 로드되어 있을 때 CPU에 어느 프로세스를 할당할 지를 결정하는 것이다. 멀티프로그래밍 기반의 운영체제에서 필수적인 요소이다.

스케줄링 시스템을 통해 다른 프로세스가 입출력을 기다리는 동안 CPU를 사용할 수 있게해 CPU 효율을 최대화한다.

### CPU I/O Burst Cycle

프로세스는 다음과 같은 두 사이클을 반복하며 실행된다.

- CPU 버스트: 실제 CPU를 사용하는 시간, 점유 시간
- I/O 버스트: 시스템에서 데이터 전송을 기다리는 시간

### CPU Scheduler

- ready 상태의 프로세스 중 CPU에 할당할 프로세스를 선택해야한다.
- 대기상태 중인 프로세스들은 ready qeuue에 위치해 있다.

### Preemptive vs Non-preemptive Scheduling

CPU 스케줄링은 다음과 같은 조건에서 발생한다.

- running 상태에서 waiting 상태에서 전환될 때(1)
- running 상태에서 ready 상태로 전환될 때(2)
- waiting 상태에서 ready 상태로 전활될 때(3)
- 프로세스가 terminate 될 때(4)

선점형 스케줄링이란 CPU를 선점하고 있는 프로세스에서 다른 프로세스로 전환할 수 있는 스케줄링이며 비선점형 스케줄링이란 프로세스가 CPU를 선점하고 있으면 프로세스가 릴리즈 될 때까지 다른 프로세스를 사용할 수 없는 스케줄링이다.

(2), (3)의 경우 선점형 또는 비선점형을 선택해 수행해야한다.

### Dispatcher

디스패처란 CPU 코어에 제어권을 넘겨주는 모듈이다.

- 컨텍스트 전환
- 사용자 모드로 전환
- 새로 로드된 프로그램에서 적절한 위치로 이동

하는 역할을 한다.

<br>

## Scheduling Criteria

스케줄링의 목표는 다음과 같다.

- CPU 사용률 최대화
- 처리량 향상
- 반환 시간 최소화: 실행에서 종료까지의 시간을 최소화한다.
- 대기 시간 최소화: 프로세스가 ready queue에서 대기하고 있는 시간을 최소화해 시스템 효율을 높인다.
- 응답 시간 최소화

<br>

## Scheduling Algorithm

### FCFS: First Come First Serve

- 가장 먼저 CPU 할당을 요청한 프로세스가 먼저 점유한다.
- 가장 간단한 CPU 스케줄링 알고리즘이다.
- FIFO 구조의 queue를 통해 쉽게 구현할 수 있다.
- 비선점형이다.

```
process - burst time
P1 - 24
P2 - 3
P3 - 3

1. P1 -> P2 -> P3 순서로 CPU를 점유할 경우
  - 평균 대기시간: (0 + 24 + 27) / 3 = 17

2. P2 -> P3 -> P1 순서로 CPU를 점유할 경우
  - 평균 대기시간: (0 + 3 + 6) / 3 = 3
```

- 호송 효과(convoy effect): CPU 사용시간이 많은 프로세스가 가장 먼저 점유하고 사용시간이 아주 작은 프로세스들이 이어서 점유할 경우 대기 시간 측면에서 손해가 크다.

### SJF: Shortest Job First

- 프로세스들의 CPU 버스트를 고려해 프로세스를 할당한다.
- CPU가 사용가능한 상태일 떄 CPU 버스트가 가장 작은 프로세스를 할당한다.
- 선점형, 비선점형 둘 다 가능하다.

```
process - burst time
P1 - 6
P2 - 8
P3 - 7
P4 - 3

1. P4 -> P1 -> P3 -> P2 순서로 CPU를 점유할 경우
  - 평균 대기시간: (0 + 3 + 9 + 16) / 4 = 7

2. FCFS로 CPU를 점유할 경우
  - 평균 대기시간: (0 + 6 + 14 + 21) / 4 = 10.25
```

- FCFS에 비해 평균 대기 시간이 줄어들지만, 다음 프로세스의 CPU 버스트를 예측하는 것은 사실상 불가능에 가깝다. 그렇기 때문에 프로세스의 이전 CPU 버스트 시간 가지고 지수적 평균을 구해 스케줄링을 구현한다.

### SRTF: Short Remaining Time First Scheduling

- SJF의 선점적 스케줄링이다.
- 프로세스의 도착 시간과 버스트 시간을 고려해 잔여 버스트 시간이 작은 프로세스를 선점적으로 할당한다.

```
process - arrival time - burst time
P1 - 0 - 8
P2 - 1 - 4
P3 - 2 - 9
P4 - 3 - 5

1. 선점적으로 프로세스 할당
  - P1(0, 1) -> P2(1, 5) -> P4(5, 10) -> P1(10, 17) -> P3(17, 26)
  - 평균 대기시간: ((5-3) + (10-1) + (17-2)) / 4 = 26 / 4 = 6.5

2. 비선점적 SJF, FCFS
  - 평균 대기시간: 7.75(SJF), 8.75(FCFS)
```

### RR: Round Robin

- 타임 퀀텀(슬라이스)을 사용한 선점적 스케줄링이다.
- ready queue를 circular queue로 구현한다.
- 평균 대기시간이 다른 스케줄링 알고리즘보다 길어 질 수 있다.
- 타임 퀀텀을 어떻게 주느냐에 따라 성능이 달라진다.
  - 타임 퀀텀이 너무 짧으면 컨텍스트 스위칭이 자주 발생해 디스패치 지연 시간으로 성능이 악화된다.
  - 타임 퀀텀이 너무 길면 FCFS와 같은 성능이 된다.

```
process - burst time
P1 - 24
P2 - 3
P3 - 3

time quantum = 4

P1(0, 4) -> P2(4, 7) -> P3(7, 10) -> P1(10 , 14) ... -> P1(26, 30)
  - 평균 대기시간: (6 + 4 + 7) / 3 = 5.66
```

### Priority Scheduling

- 프로세스의 우선순위에 따라 할당하는 스케줄링이다.
- SJF도 우선순위 스케줄링에 포함된다. SJF에서는 CPU 버스트 시간이 클 수록 낮은 우선순위를 가진다.
- 선점적, 비선점적 둘 다 가능하다.
- 기아현상이 발생한다.
  - 높은 우선순위의 프로세스가 계속해서 ready queue에 푸시되면 낮은 우선순위의 프로세스는 무한히 대기하게 된다.
  - 대기 시간에 따른 aging을 통해 해결해야 한다.

```
process - burst time - priority
P1 - 10 - 3
P2 - 1 - 1
P3 - 2 - 4
P4 - 1 - 5
P5 - 5 - 2

P2 -> P5 -> P1 -> P3 -> P4
  - 평균 대기시간 : 8.2
```

### Multi Level Queue

- queue 별로 우선순위를 부여하는 스케줄링이다.
- 우선순위가 높은 queue는 타임 퀀텀을 짧게 주고 우선 순위가 낮은 queue는 타임 퀀텀을 길게 주는 방식으로 RR 스케줄링 알고리즘과 함께 사용될 수 있다.

<br>

## Thread Scheduling

현대의 운영체제에서는 프로세스 단위의 스케줄링이 아닌 쓰레드 단위의 스케줄링 즉, 쓰레드를 CPU에 할당하는 스케줄링을 한다.

- 커널 쓰레드는 커널에 의해 생성되는 쓰레드이다.
- 유저 쓰레드는 쓰레드 라이브러리에 의해 관리되는 쓰레드이다.

<br>

## Real-Time CPU Scheduling

실시간 CPU 스케줄링이란 주어진 시간 내에 task를 실행할 수 있는 운영체제에서의 스케줄링이다.

- soft 실시간 시스템: 데드라인을 어겨도 크게 성능에 영향을 주지 않는다.(컴퓨터, 모바일, 네트워크 관련 장치)
- hard 실시간 시스템: task들이 우선순위를 가지며 데드라인안에 무조건 실행된다.(화재 경보 시스템, 항공기, 자동차)

<br>

---

### Summary

- CPU 스케줄링이란 프로세스가 메모리에 로드되어 있을 때 CPU에 어느 프로세스를 할당할 지 결정하는 것이다.
- 선점형 스케줄링이란 선점하고 있는 프로세스가 다른 프로세스로 전환될 수 있는 스케줄링이다.
- 비선점형 스케줄링이란 프로세스가 CPU를 선점하고 있으면 릴리즈 될 때가지 전환할 수 없는 스케줄링이다.
- 디스패처란 CPU 코어에 제어권을 넘겨주는 모듈이며 컨텍스트 전환, 사용자 모드 전환등의 역할을 한다.
- 스케줄링은 CPU 사용율 최대화, 처리량 향상, 반환/대기시간 최소화 등을 목표로 수행된다.
- FCFS는 가장 먼저 CPU 할당을 요청한 프로세스가 먼저 CPU를 점유한다. (선점적)
- SJF는 CPU 버스트 시간이 가장 작은 프로세스를 할당한다. (선점적, 비선점적)
- SRTF는 잔여 버스트 시간이 작은 프로세스를 할당한다. (선점적)
- RR은 타임 퀀텀을 사용한 스케줄링이다. (선점적)
- 우선순위 스케줄링은 프로세스를 우선순위에 따라 할당하는 스케줄링이며 기아현상이 발생할 수 있다.(선점적, 비선점적)
- 현대의 운영체제에서는 프로세스 단위가 아닌 쓰레드 단위의 스케줄링을 지원한다.
